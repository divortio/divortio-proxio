# =====================================================================================
# Wrangler Configuration for Divortio Worker Proxy
# Version: 10.0.0 (Optimized & Cleaned)
# =====================================================================================
name = "divortio-proxio"
main = "src/worker.mjs"

# --- Optimization & Compatibility ---
# Use the modern date you requested.
compatibility_date = "2025-10-29"

# Minify the output script to reduce bundle size and improve cold starts.
minify = true

# Disable Node.js compatibility mode.
# This proxy uses standard Web APIs (fetch, Request, Response), so we don't need the Node.js polyfills.
# Disabling this reduces the bundle size significantly.
node_compat = false

# --- Routing ---
# Disable the legacy *.workers.dev subdomain for production.
# This ensures traffic only comes through your custom domain routes.
workers_dev = false

# The proxy listens on the root domain and all subdomains.
[[routes]]
pattern = "*.proxy.example.com"
custom_domain = true

[[routes]]
pattern = "proxy.example.com"
custom_domain = true

# --- Static Assets ---
# Configures the binding to serve files from the /public directory.
# run_worker_first = true ensures our worker code executes before serving assets,
# allowing us to inject headers or intercept specific asset paths.
[assets]
directory = "./public"
binding = "ASSETS"
run_worker_first = true

# --- Performance & Observability ---
# Smart Placement automatically moves the worker execution to a location
# that minimizes latency to backend services (if applicable), or keeps it at the edge.
[placement]
mode = "smart"

# Enable full tracing for detailed performance analysis in Cloudflare Dashboard.
[observability]
enabled = true
head_sampling_rate = 1.0

[vars]
# --- Core Proxy Configuration ---
ROOT_DOMAIN = "proxy.example.com"

# Cookies restricted to the Landing Page / Dashboard
# Ex: 'admin_session', 'dashboard_prefs'
COOKIE_ROOT_PASSTHROUGH = '["admin_*", "dash_pref"]'

# Cookies allowed to "float" while browsing
# These are your Auth tokens. They reach the Worker but are STRIPPED before Origin.
# Ex: 'Divortio-Auth', 'cf_clearance'
COOKIE_PROXY_PASSTHROUGH = '["Divortio-*", "cf_*", "My-Auth-Token"]'

# --- Caching Configuration ---
# Controls the Edge Cache behavior.
CACHE_ENABLED = true
# Default TTL in seconds (1 hour)
CACHE_TTL = 3600
# JSON array of content types we are allowed to cache.
CACHEABLE_TYPES = '["image/", "font/", "text/css", "application/javascript", "application/x-javascript"]'

# --- Feature Flags ---
# Controls internal behavior.
# stealthMode: Enforces rigorous anti-fingerprinting measures.
# serviceWorker: Enables the injection of the Service Worker for network interception.
FEATURES_STEALTH_MODE = true
FEATURES_SERVICE_WORKER = true

# Note: Authentication is now handled by Cloudflare Access (Zero Trust).
# Ensure you have an Access Policy attached to your custom domain.